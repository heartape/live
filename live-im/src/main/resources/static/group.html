<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>index</title>
    <script src="js/stomp.min.js"></script>
</head>
<body>
<div id="app" style="width: 610px; height: 500px; margin: 50px auto">
    <label for="group-input"></label>
    <span>群聊id</span>
    <input type="text" id="group-input" style="width: 400px; height: 50px; font-size: 20px">
    <button onclick="subscribe()" style="height: 55px; width: 90px; font-size: 18px">加入</button>
    <div style="margin-top: 30px">
        <div id="message" style="overflow: scroll; overflow-x: hidden; height: 500px; width: 600px; border: 1px solid dimgray; margin-bottom: 10px"></div>
        <label for="message-input"></label>
        <input type="text" id="message-input" style="width: 500px; height: 50px; font-size: 20px">
        <button onclick="send()" style="height: 55px; width: 90px; font-size: 18px">send</button>
    </div>
</div>
</body>
<script>
    const groupInput = document.getElementById(`group-input`);
    const messageInput = document.getElementById(`message-input`);
    const message = document.getElementById(`message`);
    const token = localStorage.getItem('X-Token');

    const client = Stomp.client("ws://127.0.0.1:8082/im");

    let id;
    client.connect({'Authorization': 'Bearer ' + token}, function(flame){
        id = flame.headers['user-name'];
    }, function (error) {})

    function subscribe() {
        const path ='/group/' + groupInput.value;
        client.subscribe(path , function(flame) {
            setMessageInnerHTML(flame.body);
        }, {'Authorization': 'Bearer ' + token,
            id: id + path
        })

        const userPath = '/user/' + id + '/group/' + groupInput.value;
        client.subscribe(userPath , function(flame) {
            setMessageInnerHTML('private:' + flame.body);
        }, {'Authorization': 'Bearer ' + token,
            id: id + userPath
        })
    }

    function send() {
        const path ='/server/group/' + groupInput.value;
        const body = {
            'type': 'TEXT',
            'content': {
                'text': messageInput.value
            }
        };
        messageInput.value = null;
        client.send(path, {
            'Authorization': 'Bearer ' + token,
            id
        }, JSON.stringify(body));
    }

    function setMessageInnerHTML(innerHTML) {
        message.innerHTML += innerHTML + '<br/>';
    }
</script>
</html>